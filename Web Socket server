import 'dart:io';

void main() async {
  var server = await HttpServer.bind('127.0.0.1', 8080);
  print('WebSocket server listening on ${server.address}:${server.port}');

  await for (var request in server) {
    if (WebSocketTransformer.isUpgradeRequest(request)) {
      handleWebSocket(request);
    } else {
      // Handle non-WebSocket requests as needed
      request.response.statusCode = HttpStatus.badRequest;
      request.response.write('WebSocket connections only.');
      await request.response.close();
    }
  }
}

void handleWebSocket(HttpRequest request) async {
  WebSocket socket = await WebSocketTransformer.upgrade(request);

  print('WebSocket connection established.');

  socket.listen(
    (dynamic data) {
      print('Received: $data');
      socket.add('Server received: $data');
    },
    onDone: () {
      print('WebSocket connection closed.');
    },
    onError: (error) {
      print('Error: $error');
    },
    cancelOnError: true,
  );
}
